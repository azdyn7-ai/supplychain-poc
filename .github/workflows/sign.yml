name: Sign & Attest Image (SLSA L2)

on:
  workflow_run:
    workflows: ["Build & Push Image"]
    types:
      - completed

permissions:
  contents: read
  id-token: write
  packages: read

jobs:
  sign:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download image reference artifact
        uses: actions/download-artifact@v4
        with:
          name: image-ref
          path: .

      - name: Read image reference
        id: image
        run: |
          echo "IMAGE_REF=$(cat image-ref.txt)" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: latest

      - name: Pull image
        run: |
          docker pull $IMAGE_REF

      - name: Sign image (Cosign keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign $IMAGE_REF

      - name: Attest SLSA provenance
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign attest \
            --type slsaprovenance \
            $IMAGE_REF

      - name: Verify signature (optional)
        run: |
          cosign verify $IMAGE_REF || true
